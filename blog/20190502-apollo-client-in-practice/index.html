<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 3.10.2"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link as="script" rel="preload" href="/codestar-website-gatsby/webpack-runtime-e7d3bdff8b55f220725c.js"/><link as="script" rel="preload" href="/codestar-website-gatsby/framework-27057898c5c6370eb401.js"/><link as="script" rel="preload" href="/codestar-website-gatsby/app-d3b1bd593aab3d9e1299.js"/><link as="script" rel="preload" href="/codestar-website-gatsby/component---src-pages-blog-mdx-slug-tsx-71a17c6b6f8c15324446.js"/><link as="fetch" rel="preload" href="/codestar-website-gatsby/page-data/blog/20190502-apollo-client-in-practice/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/codestar-website-gatsby/page-data/sq/d/2648336773.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/codestar-website-gatsby/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div class="MuiContainer-root MuiContainer-maxWidthLg"><header class="MuiPaper-root MuiAppBar-root MuiAppBar-positionStatic MuiAppBar-colorPrimary jss1 MuiPaper-elevation4"><div class="MuiToolbar-root MuiToolbar-regular jss2 MuiToolbar-gutters"><h2 class="MuiTypography-root jss3 MuiTypography-h5 MuiTypography-colorInherit MuiTypography-noWrap"><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper gatsby-image-wrapper-constrained"><div style="max-width:216px;display:block"><img alt="" role="presentation" aria-hidden="true" src="data:image/svg+xml;charset=utf-8,%3Csvg height=&#x27;43&#x27; width=&#x27;216&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; version=&#x27;1.1&#x27;%3E%3C/svg%3E" style="max-width:100%;display:block;position:static"/></div><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#080808;position:absolute;top:0;left:0;bottom:0;right:0"></div><picture><source type="image/webp" data-srcset="/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/62e3d/codestar_logo_dark.webp 54w,/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/2b678/codestar_logo_dark.webp 108w,/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/c62d3/codestar_logo_dark.webp 216w" sizes="(min-width: 216px) 216px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 216px) 216px, 100vw" decoding="async" loading="lazy" data-src="/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/1a089/codestar_logo_dark.svg" data-srcset="/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/bec45/codestar_logo_dark.svg 54w,/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/b8de0/codestar_logo_dark.svg 108w,/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/1a089/codestar_logo_dark.svg 216w" alt="Codestar Logo"/></picture><noscript><picture><source type="image/webp" srcSet="/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/62e3d/codestar_logo_dark.webp 54w,/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/2b678/codestar_logo_dark.webp 108w,/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/c62d3/codestar_logo_dark.webp 216w" sizes="(min-width: 216px) 216px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 216px) 216px, 100vw" decoding="async" loading="lazy" src="/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/1a089/codestar_logo_dark.svg" srcSet="/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/bec45/codestar_logo_dark.svg 54w,/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/b8de0/codestar_logo_dark.svg 108w,/codestar-website-gatsby/static/586e1d088af027ab83f631dbd1e7f569/1a089/codestar_logo_dark.svg 216w" alt="Codestar Logo"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1)}}</script></div></h2><a class="MuiTypography-root MuiLink-root MuiLink-underlineHover jss5 MuiTypography-body2 MuiTypography-colorInherit MuiTypography-noWrap" href="/codestar-website-gatsby/">Home</a><a class="MuiTypography-root MuiLink-root MuiLink-underlineHover jss5 MuiTypography-body2 MuiTypography-colorInherit MuiTypography-noWrap" href="/codestar-website-gatsby/blog">Blog</a><a class="MuiTypography-root MuiLink-root MuiLink-underlineHover jss5 MuiTypography-body2 MuiTypography-colorInherit MuiTypography-noWrap" href="/codestar-website-gatsby/about">About</a><a class="MuiTypography-root MuiLink-root MuiLink-underlineHover jss5 MuiTypography-body2 MuiTypography-colorInherit MuiTypography-noWrap" href="/codestar-website-gatsby/learning">Learning</a><a class="MuiTypography-root MuiLink-root MuiLink-underlineHover jss5 MuiTypography-body2 MuiTypography-colorInherit MuiTypography-noWrap" href="/codestar-website-gatsby/events">Events</a><a class="MuiTypography-root MuiLink-root MuiLink-underlineHover jss5 MuiTypography-body2 MuiTypography-colorInherit MuiTypography-noWrap" href="https://www.ordina.nl/vakgebieden/scala/">Contact</a></div></header><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><h2 class="MuiTypography-root MuiTypography-h2 MuiTypography-gutterBottom">Apollo Client in Practice</h2><p class="MuiTypography-root MuiTypography-body2 MuiTypography-gutterBottom">May 2, 2019</p><p>Some time ago I joined a team that is working on a search application. The application takes search terms and displays the results in a table with potentially dozens of columns and hundreds of rows, even before pagination. It is implemented in React and uses Apollo for GraphQL calls. I was surprised to find it noticeably slow when a lot of search results were retrieved. React is well-known for leveraging virtual DOM to optimize performance and GraphQL should even be able to add caching to further optimize performance on the side of network requests.</p><p>Looking into the performance tab of Chrome dev tools lead me to believe the performance problems were caused by computations in the bottom components (e.g. formatting in cells). Because there are so many and they are re-rendered quite often, this approach is quite intensive on resources.</p><p>Besides that, the application had obvious state synchronization problems. When moving between views it was not maintaining the same state of selected rows. Even though Redux was used to store application state and communicate it between components, it was not used consistently. There were still plenty of React class components that stored some parts of the state locally.</p><p>To summarize, there were two issues that needed to be solved:</p><ul><li>Poor performance due to excessive re-rendering</li><li>Loss of application state when navigating views due to decentralized state stores</li></ul><p>Since both issues were caused by (a lack of) architecture, we redesigned the structure of the application. The original implementation used:</p><ul><li>Apollo Client as a GraphQL client</li><li>Axios as an HTTP client for REST endpoints</li><li>Redux and React local state to manage the state between components</li></ul><p>It used Apollo, but by manually firing client.query() and after processing the response, it stored the result in the Redux store.
Fixing application state with Apollo Local State</p><p>When restructuring the application, Apollo Client was updated to 2.5. This version has a built-in local state manager (formerly apollo-link-state) and it supports REST calls with the apollo-link-rest plugin. The apollo-boost package contains the client and several useful plugins. Adopting these means that both Redux and Axios can be removed and Apollo will be used as a single source of truth. If there is a single store for the data, there is no need for synchronization and with that one of the issues is solved.</p><p>The way we used Apollo Client was also updated, to create a better separation of UI and data. Instead of using client.query() directly in the component lifecycle methods, components are split into a presentational component and enhanced with the graphql() HOC to add data from remote (i.e. GraphQL back-end) or local fields. Both utilize the Apollo cache, which fulfills multiple functions, one of them an application local state store.</p><p>Example of wrapping a component in a Query HOC:
...</p><pre><code class="language-typescript{numberLines:" metastring="true}">// This is an example for syntax highlighting
const x: string = &quot;some string&quot;;
</code></pre><h1>Next steps</h1><p>Apollo is excellent for merging data from multiple sources (in this case GraphQL, REST, local state and cache) and functions as a “single source of truth” which should solve the state synchronization problems. The local fields that Apollo uses in its local state manager can derive data, moving expensive operations from component render functions to resolvers in its application level cache. Although the issues mentioned in the introduction are now dealt with, we did encounter plenty of other issues I may dive into later. However, these are some things that you might want to take into account when working with Apollo Client:</p><p>Outside of restructuring the application, we improved performance with react-virtualized which speeds up rendering large tables. Apollo also offers GraphQL pagination. We did not use that, as we have to do our pagination on the client side to keep the sorting feature of react-virtualized in tact.</p><p>Apollo Client offers support for TypeScript, it is even possible to generate queries and typed React components from GraphQL schemas with <code>@graphql-codegen/cli</code>.</p><p>Also definitely use the JS GraphQL IntelliJ Plugin because it will not only auto complete queries, but it will help you think about (client side) schema’s.</p><p>When the Query component mounts, it creates an observable that subscribes to the query in the query prop. This encourages reactive behavior like RxJS (which can also be used as a state store). However, it seems that Apollo offers much less fine-grained control over the observables than what RxJS provides. And considering observables, Apollo Client effortlessly scales to web sockets!</p><p>Are you looking for inspiration on how Apollo client can be applied? I can recommend this talk by Uri Goldshtein and this introduction to Apollo state management by Sara Vieira.</p></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><footer class="jss6"><div class="MuiContainer-root MuiContainer-maxWidthLg"><h6 class="MuiTypography-root MuiTypography-h6 MuiTypography-gutterBottom MuiTypography-alignCenter">codestar@ordina.nl</h6><p class="MuiTypography-root MuiTypography-subtitle1 MuiTypography-colorTextSecondary MuiTypography-alignCenter">+31 30 6637000 <!-- --> <!-- -->Ringwade 1, 3439 LM Nieuwegein</p><p class="MuiTypography-root MuiTypography-body2 MuiTypography-colorTextSecondary MuiTypography-alignCenter">Copyright © <a class="MuiTypography-root MuiLink-root MuiLink-underlineHover MuiTypography-colorInherit" href="https://codestar.nl">Codestar</a> <!-- -->2021</p></div></footer></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/20190502-apollo-client-in-practice/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-4f68119b70dfe875848d.js"],"app":["/app-d3b1bd593aab3d9e1299.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-0479a2e049dcaead0f36.js"],"component---src-pages-about-tsx":["/component---src-pages-about-tsx-bf9d252af35e2c8eba5b.js"],"component---src-pages-blog-index-tsx":[],"component---src-pages-blog-mdx-slug-tsx":["/component---src-pages-blog-mdx-slug-tsx-71a17c6b6f8c15324446.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-38993e11e77d9907a5c4.js"]};/*]]>*/</script><script src="/codestar-website-gatsby/polyfill-4f68119b70dfe875848d.js" nomodule=""></script><script src="/codestar-website-gatsby/component---src-pages-blog-mdx-slug-tsx-71a17c6b6f8c15324446.js" async=""></script><script src="/codestar-website-gatsby/app-d3b1bd593aab3d9e1299.js" async=""></script><script src="/codestar-website-gatsby/framework-27057898c5c6370eb401.js" async=""></script><script src="/codestar-website-gatsby/webpack-runtime-e7d3bdff8b55f220725c.js" async=""></script></body></html>